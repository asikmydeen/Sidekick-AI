(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function o(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=o(s);fetch(s.href,r)}})();function ve(){(typeof chrome>"u"||!chrome.storage)&&(console.log("Running in web preview mode - mocking Chrome APIs"),window.chrome={storage:{local:{get:async e=>{const t={};return(Array.isArray(e)?e:[e]).forEach(i=>{const s=localStorage.getItem(i);s&&(t[i]=JSON.parse(s))}),t},set:async e=>{Object.entries(e).forEach(([t,o])=>{localStorage.setItem(t,JSON.stringify(o))})}}},runtime:{onInstalled:{addListener:()=>{}},onMessage:{addListener:()=>{}}},tabs:{query:async()=>[{id:1,url:"https://example.com"}]},scripting:{executeScript:async({target:e,func:t})=>[{result:`This is a mock page content from the web preview mode.

It simulates what the extension would read from a real webpage.`}]},sidePanel:{setPanelBehavior:async()=>{}}})}const le=`Summarize|Summarize the key points of the following content:
Explain|Explain this concept in simple terms:
Fix Grammar|Please fix the grammar in this text:
Code Review|Review this code for bugs and improvements:`;function de(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}let a={provider:"",apiKey:"",endpoint:"http://localhost:11434",awsAccessKey:"",awsSecretKey:"",awsRegion:"us-east-1",model:"",systemPrompt:"",temperature:.7,quickPrompts:le,theme:"light",autoRead:!1,currentSessionId:null,sessions:[]};async function Ee(){const e=await chrome.storage.local.get(["chatState"]);if(e.chatState){if(e.chatState.messages&&!e.chatState.sessions){const t={id:de(),title:"Previous Chat",messages:e.chatState.messages,lastModified:Date.now()};a={...a,...e.chatState,sessions:[t],currentSessionId:t.id},delete a.messages}else a={...a,...e.chatState};a.temperature===void 0&&(a.temperature=.7),a.autoRead===void 0&&(a.autoRead=!1),a.quickPrompts||(a.quickPrompts=le),a.endpoint||(a.endpoint="http://localhost:11434"),a.awsRegion||(a.awsRegion="us-east-1"),a.sessions.length===0?N():(!a.currentSessionId||!a.sessions.find(t=>t.id===a.currentSessionId))&&(a.currentSessionId=a.sessions[0].id)}else N();return a}function _(){chrome.storage.local.set({chatState:a})}function ne(e){a={...a,...e},_()}function N(){const e={id:de(),title:"New Chat",messages:[],lastModified:Date.now()};return a.sessions.unshift(e),a.currentSessionId=e.id,_(),e}function D(){return a.sessions.find(e=>e.id===a.currentSessionId)}function Z(e){var o;const t=D();if(t){if(t.messages=e,t.lastModified=Date.now(),t.title==="New Chat"&&e.length>0){const i=e.find(s=>s.role==="user");if(i){let s=i.content;Array.isArray(s)&&(s=((o=s.find(r=>r.type==="text"))==null?void 0:o.text)||"Image"),t.title=s.slice(0,30)+(s.length>30?"...":"")}}_()}}function Ie(e){a.sessions=a.sessions.filter(t=>t.id!==e),a.currentSessionId===e&&(a.sessions.length>0?a.currentSessionId=a.sessions[0].id:N()),_()}function Be(e){a.sessions.find(o=>o.id===e)&&(a.currentSessionId=e,_())}function xe(){a.sessions=[],N()}async function Ce(){try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e)return null;if(e.url.startsWith("chrome://"))return"Cannot read system pages.";const t=await chrome.scripting.executeScript({target:{tabId:e.id},func:()=>document.body.innerText});if(t&&t[0]&&t[0].result){const o=t[0].result;return o.length>2e4?o.substring(0,2e4)+`
...[Content Truncated]`:o}return null}catch(e){return console.error("Failed to read page:",e),`Error reading page: ${e.message}`}}function be(e){return Math.ceil(e.length/4)}function Le(e){return new Promise((t,o)=>{const i=new FileReader;i.onload=s=>t(s.target.result),i.onerror=s=>o(s),i.readAsText(e)})}const n={container:document.querySelector(".container"),configSection:document.getElementById("configSection"),chatSection:document.getElementById("chatSection"),advancedSettings:document.getElementById("advancedSettings"),providerSelect:document.getElementById("provider"),apiKeyInput:document.getElementById("apiKey"),apiKeyGroup:document.getElementById("apiKeyGroup"),endpointInput:document.getElementById("endpoint"),endpointGroup:document.getElementById("endpointGroup"),awsGroup:document.getElementById("awsGroup"),awsAccessKey:document.getElementById("awsAccessKey"),awsSecretKey:document.getElementById("awsSecretKey"),awsRegion:document.getElementById("awsRegion"),fetchModelsBtn:document.getElementById("fetchModelsBtn"),fetchStatus:document.getElementById("fetchStatus"),modelSelect:document.getElementById("model"),modelSelectionDiv:document.getElementById("modelSelection"),systemPromptInput:document.getElementById("systemPrompt"),temperatureInput:document.getElementById("temperature"),tempValueLabel:document.getElementById("tempValue"),quickPromptsInput:document.getElementById("quickPromptsConfig"),autoReadInput:document.getElementById("autoRead"),startChatBtn:document.getElementById("startChatBtn"),settingsBtn:document.getElementById("settingsBtn"),historyBtn:document.getElementById("historyBtn"),newChatBtn:document.getElementById("newChatBtn"),historySidebar:document.getElementById("historySidebar"),sessionList:document.getElementById("sessionList"),closeSidebarBtn:document.getElementById("closeSidebarBtn"),clearHistoryBtn:document.getElementById("clearHistoryBtn"),exportBtn:document.getElementById("exportBtn"),themeBtn:document.getElementById("themeBtn"),chatHistory:document.getElementById("chatHistory"),messageInput:document.getElementById("messageInput"),sendBtn:document.getElementById("sendBtn"),stopBtn:document.getElementById("stopBtn"),micBtn:document.getElementById("micBtn"),fileBtn:document.getElementById("fileBtn"),fileInput:document.getElementById("fileInput"),includePageContent:document.getElementById("includePageContent"),promptChipsContainer:document.getElementById("promptChips"),tokenCount:document.getElementById("tokenCount"),attachmentPreview:document.getElementById("attachmentPreview")};function ue(e){e==="dark"?(document.body.classList.add("dark-mode"),n.themeBtn.textContent="â˜€ï¸"):(document.body.classList.remove("dark-mode"),n.themeBtn.textContent="ðŸŒ™")}function $(e,t){n.fetchStatus.textContent=e,n.fetchStatus.className=`status-msg ${t}`}function me(e){e==="chat"?(n.configSection.classList.add("hidden"),n.chatSection.classList.remove("hidden"),n.settingsBtn.style.display="block",n.historyBtn.classList.remove("hidden"),n.newChatBtn.classList.remove("hidden"),n.exportBtn.classList.remove("hidden")):(n.configSection.classList.remove("hidden"),n.chatSection.classList.add("hidden"),n.settingsBtn.style.display="none",n.historyBtn.classList.add("hidden"),n.newChatBtn.classList.add("hidden"),n.exportBtn.classList.add("hidden"))}function se(e){e?n.historySidebar.classList.add("open"):n.historySidebar.classList.remove("open")}function oe(e,t,o,i){n.sessionList.innerHTML="",e.forEach(s=>{const r=document.createElement("div");r.className=`session-item ${s.id===t?"active":""}`;let c=s.title||"New Chat";const l=document.createElement("span");l.className="session-title",l.textContent=c,l.onclick=()=>o(s.id);const d=document.createElement("button");d.textContent="Ã—",d.className="session-delete",d.onclick=m=>{m.stopPropagation(),i(s.id)},r.appendChild(l),r.appendChild(d),n.sessionList.appendChild(r)})}function ke(e){n.modelSelect.innerHTML='<option value="" disabled selected>Select a model...</option>',e.forEach(t=>{const o=document.createElement("option");o.value=t,o.textContent=t,n.modelSelect.appendChild(o)})}function Ae(e,t){n.promptChipsContainer.innerHTML="",e.split(`
`).forEach(i=>{if(!i.trim())return;const s=i.split("|"),r=s[0].trim(),c=s.length>1?s.slice(1).join("|").trim():r;if(!r)return;const l=document.createElement("button");l.className="chip",l.textContent=r,l.title=c,l.addEventListener("click",()=>t(c)),n.promptChipsContainer.appendChild(l)})}function $e(e,t){n.chatHistory.innerHTML="";const o=document.createElement("div");o.className="status-msg",o.textContent=`Chatting with ${t}`,n.chatHistory.appendChild(o),e.forEach(i=>{W(i.role,i.content)}),Q(),fe(e)}function W(e,t,o=null,i=!1){var c;const s=document.createElement("div");s.className=`message ${e}`,o&&(s.id=o);let r="";if(typeof t=="string"?r=t:Array.isArray(t)&&(r=((c=t.find(l=>l.type==="text"))==null?void 0:c.text)||""),i)s.innerHTML='<div class="typing-dots"><span></span><span></span><span></span></div>';else if(Array.isArray(t)?t.forEach(l=>{if(l.type==="text"){const d=document.createElement("div");d.innerHTML=V(l.text),s.appendChild(d)}else if(l.type==="image_url"){const d=document.createElement("img");d.src=l.image_url.url,d.className="chat-image",s.appendChild(d)}}):t&&(s.innerHTML=V(t)),e==="assistant"&&r){const l=document.createElement("div");l.className="msg-controls";const d=document.createElement("button");d.className="msg-btn",d.textContent="ðŸ”Š",d.title="Read aloud",d.onclick=()=>pe(r,d),l.appendChild(d),s.appendChild(l)}n.chatHistory.appendChild(s),s.querySelectorAll(".copy-btn").forEach(l=>{l.addEventListener("click",d=>{const m=d.target.parentElement.querySelector("code").textContent;navigator.clipboard.writeText(m);const C=d.target.textContent;d.target.textContent="Copied!",d.target.classList.add("copied"),setTimeout(()=>{d.target.textContent=C,d.target.classList.remove("copied")},2e3)})}),Q()}function Pe(e,t){const o=document.getElementById(e);o&&(o.innerHTML=V(t),Q())}function re(e,t){const o=document.getElementById(e);if(o){o.innerHTML="";let i="";typeof t=="string"&&(i=t);const s=document.createElement("div");s.innerHTML=V(i),o.appendChild(s);const r=document.createElement("div");r.className="msg-controls";const c=document.createElement("button");c.className="msg-btn",c.textContent="ðŸ”Š",c.title="Read aloud",c.onclick=()=>pe(i,c),r.appendChild(c),o.appendChild(r),o.querySelectorAll(".copy-btn").forEach(l=>{l.addEventListener("click",d=>{const m=d.target.parentElement.querySelector("code").textContent;navigator.clipboard.writeText(m);const C=d.target.textContent;d.target.textContent="Copied!",d.target.classList.add("copied"),setTimeout(()=>{d.target.textContent=C,d.target.classList.remove("copied")},2e3)})}),Q()}}function pe(e,t){if(window.speechSynthesis.speaking){window.speechSynthesis.cancel(),document.querySelectorAll(".msg-btn.speaking").forEach(o=>{o.classList.remove("speaking"),o.textContent="ðŸ”Š"});return}he(e,t)}function he(e,t=null){window.speechSynthesis.cancel();const o=e.replace(/[*#`_\[\]]/g,""),i=new SpeechSynthesisUtterance(o);i.lang="en-US",i.rate=1,i.onstart=()=>{t&&(t.classList.add("speaking"),t.textContent="â¹")},i.onend=()=>{t&&(t.classList.remove("speaking"),t.textContent="ðŸ”Š")},i.onerror=()=>{t&&(t.classList.remove("speaking"),t.textContent="ðŸ”Š")},window.speechSynthesis.speak(i)}function ge(){window.speechSynthesis.cancel()}function fe(e){let t="";e.forEach(r=>{typeof r.content=="string"?t+=r.content:Array.isArray(r.content)&&r.content.forEach(c=>{c.type==="text"&&(t+=c.text),c.type==="image_url"&&(t+=" ".repeat(4e3))})});const o=be(t),s=Math.min(o/128e3*100,100).toFixed(1);n.tokenCount.textContent=`${o.toLocaleString()} tokens used`,n.tokenCount.title=`Approx. ${s}% of 128k context window`}function Te(e){const t=document.getElementById(e);t&&t.remove()}function ee(e){e?(n.sendBtn.classList.add("hidden"),n.stopBtn.classList.remove("hidden"),n.messageInput.disabled=!0):(n.sendBtn.classList.remove("hidden"),n.stopBtn.classList.add("hidden"),n.messageInput.disabled=!1,n.messageInput.focus())}function Q(){n.chatHistory.scrollTop=n.chatHistory.scrollHeight}function X(){const e=n.messageInput;e.style.height="auto",e.style.height=e.scrollHeight+"px",e.value===""&&(e.style.height="")}function te(e,t){n.attachmentPreview.innerHTML="",e.forEach((o,i)=>{const s=document.createElement("div");s.className="preview-thumb";const r=document.createElement("img");r.src=o.base64;const c=document.createElement("button");c.className="remove-btn",c.textContent="Ã—",c.onclick=()=>t(i),s.appendChild(r),s.appendChild(c),n.attachmentPreview.appendChild(s)})}function V(e){if(!e)return"";let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");const o=[];return t=t.replace(/```([\s\S]*?)```/g,(i,s)=>(o.push(s),`__CODEBLOCK_${o.length-1}__`)),t=t.replace(/^### (.*$)/gm,"<h3>$1</h3>"),t=t.replace(/^## (.*$)/gm,"<h2>$1</h2>"),t=t.replace(/^# (.*$)/gm,"<h1>$1</h1>"),t=t.replace(/^[\*\-] (.*$)/gm,"<ul><li>$1</li></ul>"),t=t.replace(/`([^`]+)`/g,'<code style="background:rgba(128,128,128,0.2);padding:2px 4px;border-radius:4px;">$1</code>'),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/\*([^*]+)\*/g,"<em>$1</em>"),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>'),t=t.replace(/\n/g,"<br>"),t=t.replace(/__CODEBLOCK_(\d+)__/g,(i,s)=>`<div class="code-wrapper"><button class="copy-btn">Copy</button><pre><code>${o[s]}</code></pre></div>`),t}async function O(e,t){const o=new TextEncoder,i=typeof e=="string"?o.encode(e):e,s=await crypto.subtle.importKey("raw",i,{name:"HMAC",hash:"SHA-256"},!1,["sign"]);return crypto.subtle.sign("HMAC",s,o.encode(t))}async function ce(e){const t=new TextEncoder,o=await crypto.subtle.digest("SHA-256",t.encode(e));return Array.from(new Uint8Array(o)).map(i=>i.toString(16).padStart(2,"0")).join("")}function Re(e){return Array.from(new Uint8Array(e)).map(t=>t.toString(16).padStart(2,"0")).join("")}async function ye({method:e,url:t,headers:o,body:i,accessKey:s,secretKey:r,region:c,service:l}){const m=new Date().toISOString().replace(/[:-]|\.\d{3}/g,""),C=m.slice(0,8),p=new URL(t).host,u=new URL(t).pathname,S="";o.host=p,o["x-amz-date"]=m;const P=Object.keys(o).map(h=>h.toLowerCase()).sort(),K=P.map(h=>`${h}:${o[h].trim()}
`).join(""),A=P.join(";"),j=await ce(i||""),q=[e,u,S,K,A,j].join(`
`),M="AWS4-HMAC-SHA256",H=`${C}/${c}/${l}/aws4_request`,U=[M,m,H,await ce(q)].join(`
`),F=await O(`AWS4${r}`,C),z=await O(F,c),G=await O(z,l),J=await O(G,"aws4_request"),f=Re(await O(J,U)),B=`${M} Credential=${s}/${H}, SignedHeaders=${A}, Signature=${f}`;return{...o,Authorization:B}}async function Ke(e,t,o="",i={}){let s="",r={},c=d=>[];switch(e){case"openai":s="https://api.openai.com/v1/models",r={Authorization:`Bearer ${t}`},c=p=>p.data.map(u=>u.id).filter(u=>u.startsWith("gpt")).sort();break;case"openrouter":s="https://openrouter.ai/api/v1/models",r={Authorization:`Bearer ${t}`},c=p=>p.data.map(u=>u.id).sort();break;case"huggingface":s="https://huggingface.co/api/models?pipeline_tag=text-generation&sort=downloads&direction=-1&limit=50",r={Authorization:`Bearer ${t}`},c=p=>p.map(u=>u.id);break;case"anthropic":throw new Error("Anthropic API does not support listing models automatically.");case"ollama":s=`${o.replace(/\/$/,"")}/api/tags`,c=p=>p.models.map(u=>u.name);break;case"bedrock":const m=i.region||"us-east-1";s=`https://bedrock.${m}.amazonaws.com/foundation-models?byOutputModality=TEXT`,r=await ye({method:"GET",url:s,headers:{"content-type":"application/json"},accessKey:i.accessKey,secretKey:i.secretKey,region:m,service:"bedrock"}),c=p=>p.modelSummaries.map(u=>u.modelId).sort();break;default:throw new Error("Unknown provider")}const l=await fetch(s,{headers:r});if(!l.ok){const d=await l.text();throw new Error(`API Error ${l.status}: ${d}`)}return c(await l.json())}async function*Me(e,t,o){var j,q,M,H,U,F,z,G,J;const{provider:i,apiKey:s,model:r,temperature:c,endpoint:l,systemPrompt:d,awsAccessKey:m,awsSecretKey:C,awsRegion:p}=e,u=((j=e.sessions.find(f=>f.id===e.currentSessionId))==null?void 0:j.messages)||[];let S="",P={"Content-Type":"application/json"};const K=[];d&&i!=="bedrock"&&K.push({role:"system",content:d});const A=u.map(f=>({role:f.role,content:f.content}));if(i==="openai"||i==="openrouter"){s&&(P.Authorization=`Bearer ${s}`),K.push(...A),S=i==="openai"?"https://api.openai.com/v1/chat/completions":"https://openrouter.ai/api/v1/chat/completions";const B=await fetch(S,{method:"POST",headers:P,body:JSON.stringify({model:r,messages:K,stream:!0,temperature:c}),signal:o});if(!B.ok)throw new Error(await B.text());const h=B.body.getReader(),y=new TextDecoder;for(;;){const{done:x,value:b}=await h.read();if(x)break;const L=y.decode(b,{stream:!0}).split(`
`);for(const g of L)if(g.startsWith("data: ")&&!g.includes("[DONE]"))try{const E=((H=(M=(q=JSON.parse(g.replace("data: ","")).choices)==null?void 0:q[0])==null?void 0:M.delta)==null?void 0:H.content)||"";E&&(yield E)}catch{}}}else if(i==="ollama"){S=`${l?l.replace(/\/$/,""):"http://localhost:11434"}/api/chat`;const B=A.map(v=>{if(Array.isArray(v.content)){let L="",g=[];return v.content.forEach(w=>{if(w.type==="text"&&(L+=w.text),w.type==="image_url"){const E=w.image_url.url.split(",")[1];E&&g.push(E)}}),{role:v.role,content:L,images:g.length?g:void 0}}return v}),h={model:r,messages:B,stream:!0,options:{temperature:c}};d&&(h.system=d);const y=await fetch(S,{method:"POST",headers:P,body:JSON.stringify(h),signal:o});if(!y.ok)throw new Error(await y.text());const x=y.body.getReader(),b=new TextDecoder;for(;;){const{done:v,value:L}=await x.read();if(v)break;const w=b.decode(L,{stream:!0}).split(`
`);for(const E of w)if(E.trim())try{const Y=JSON.parse(E);(U=Y.message)!=null&&U.content&&(yield Y.message.content)}catch{}}}else if(i==="bedrock"){const f=p||"us-east-1";S=`https://bedrock-runtime.${f}.amazonaws.com/model/${r}/converse`;const h={messages:A.map(g=>{const w=[];return Array.isArray(g.content)?g.content.forEach(E=>{E.type==="text"&&w.push({text:E.text})}):w.push({text:g.content}),{role:g.role,content:w}}),inferenceConfig:{temperature:c,maxTokens:2048}};d&&(h.system=[{text:d}]);const y=JSON.stringify(h),x=await ye({method:"POST",url:S,headers:{"content-type":"application/json"},body:y,accessKey:m,secretKey:C,region:f,service:"bedrock"}),b=await fetch(S,{method:"POST",headers:x,body:y,signal:o});if(!b.ok)throw new Error(await b.text());yield((J=(G=(z=(F=(await b.json()).output)==null?void 0:F.message)==null?void 0:z.content)==null?void 0:G[0])==null?void 0:J.text)||""}else if(i==="huggingface"){S=`https://api-inference.huggingface.co/models/${r}`;const B={inputs:A.map(x=>{var v;const b=Array.isArray(x.content)?(v=x.content.find(L=>L.type==="text"))==null?void 0:v.text:x.content;return`${x.role}: ${b}`}).join(`
`),parameters:{max_new_tokens:500,return_full_text:!1,temperature:c}},y=await(await fetch(S,{method:"POST",headers:{Authorization:`Bearer ${s}`},body:JSON.stringify(B),signal:o})).json();yield Array.isArray(y)?y[0].generated_text:JSON.stringify(y)}}ve();let T=null,I=null,k=[];document.addEventListener("DOMContentLoaded",async()=>{if(await Ee(),ue(a.theme),a.provider&&(n.providerSelect.value=a.provider,we(a.provider)),a.apiKey&&(n.apiKeyInput.value=a.apiKey),a.endpoint&&(n.endpointInput.value=a.endpoint),a.awsAccessKey&&(n.awsAccessKey.value=a.awsAccessKey),a.awsSecretKey&&(n.awsSecretKey.value=a.awsSecretKey),a.awsRegion&&(n.awsRegion.value=a.awsRegion),a.systemPrompt&&(n.systemPromptInput.value=a.systemPrompt),a.temperature&&(n.temperatureInput.value=a.temperature,n.tempValueLabel.textContent=a.temperature),a.quickPrompts&&(n.quickPromptsInput.value=a.quickPrompts),a.autoRead&&(n.autoReadInput.checked=a.autoRead),a.model){const e=D();e&&e.messages.length>0&&(n.modelSelect.innerHTML=`<option value="${a.model}" selected>${a.model}</option>`,n.modelSelectionDiv.classList.remove("hidden"),n.advancedSettings.classList.remove("hidden"),n.startChatBtn.classList.remove("hidden"),R())}});n.providerSelect.addEventListener("change",e=>we(e.target.value));function we(e){n.apiKeyGroup.classList.add("hidden"),n.endpointGroup.classList.add("hidden"),n.awsGroup.classList.add("hidden"),e==="ollama"?n.endpointGroup.classList.remove("hidden"):e==="bedrock"?n.awsGroup.classList.remove("hidden"):n.apiKeyGroup.classList.remove("hidden")}n.themeBtn.addEventListener("click",()=>{const e=a.theme==="light"?"dark":"light";ne({theme:e}),ue(e)});n.settingsBtn.addEventListener("click",()=>me("config"));n.startChatBtn.addEventListener("click",()=>{const e=n.modelSelect.value;if(!e)return $("Please select a model.","error");ne({model:e,systemPrompt:n.systemPromptInput.value.trim(),temperature:parseFloat(n.temperatureInput.value),quickPrompts:n.quickPromptsInput.value.trim(),autoRead:n.autoReadInput.checked}),R()});n.historyBtn.addEventListener("click",()=>{oe(a.sessions,a.currentSessionId,ae,ie),se(!0)});n.closeSidebarBtn.addEventListener("click",()=>se(!1));n.newChatBtn.addEventListener("click",()=>{N(),R()});n.clearHistoryBtn.addEventListener("click",()=>{confirm("Delete all history? This cannot be undone.")&&(xe(),oe(a.sessions,a.currentSessionId,ae,ie),R())});function ae(e){Be(e),R(),se(!1)}function ie(e){confirm("Delete this chat?")&&(Ie(e),oe(a.sessions,a.currentSessionId,ae,ie),a.currentSessionId!==e&&R())}n.exportBtn.addEventListener("click",()=>{const e=D();if(!e||e.messages.length===0)return alert("No history to export.");let t=`# ${e.title}

`;e.messages.forEach(r=>{var c;if(Array.isArray(r.content)){const l=((c=r.content.find(d=>d.type==="text"))==null?void 0:c.text)||"";t+=`### ${r.role}
${l}
[Image Attached]

`}else t+=`### ${r.role}
${r.content}

`});const o=new Blob([t],{type:"text/markdown"}),i=URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download=`chat-${e.id}.md`,s.click(),URL.revokeObjectURL(i)});n.fileBtn.addEventListener("click",()=>n.fileInput.click());n.fileInput.addEventListener("change",async e=>{const t=e.target.files[0];if(t){if(t.type.startsWith("image/")){const o=new FileReader;o.onload=i=>{const s=i.target.result;k.push({type:"image_url",base64:s}),te(k,r=>{k.splice(r,1),te(k,()=>{})})},o.readAsDataURL(t),e.target.value="";return}try{const o=await Le(t);if(/[\x00-\x08\x0E-\x1F]/.test(o))throw new Error("File content appears to be binary.");const i=`

[File Attachment: ${t.name}]
\`\`\`
${o}
\`\`\``;n.messageInput.value+=i,X()}catch(o){alert("Failed to read file. Please upload images or text files."),console.error(o)}e.target.value=""}});n.fetchModelsBtn.addEventListener("click",async()=>{const e=n.providerSelect.value,t=n.apiKeyInput.value.trim(),o=n.endpointInput.value.trim(),i=n.awsAccessKey.value.trim(),s=n.awsSecretKey.value.trim(),r=n.awsRegion.value.trim();if(!e)return $("Select a provider.","error");if(e==="bedrock"){if(!i||!s)return $("Enter AWS Credentials.","error")}else if(e!=="ollama"&&!t)return $("Enter API Key.","error");ne({provider:e,apiKey:t,endpoint:o,awsAccessKey:i,awsSecretKey:s,awsRegion:r}),$("Fetching...","info");try{const c=await Ke(e,t,o,{accessKey:i,secretKey:s,region:r});if(!c.length)throw new Error("No models found.");ke(c),$(`Found ${c.length} models.`,"success"),n.modelSelectionDiv.classList.remove("hidden"),n.advancedSettings.classList.remove("hidden"),n.startChatBtn.classList.remove("hidden")}catch(c){$(`Error: ${c.message}`,"error")}});n.temperatureInput.addEventListener("input",e=>n.tempValueLabel.textContent=e.target.value);n.messageInput.addEventListener("input",X);n.messageInput.addEventListener("keypress",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),Se())});n.sendBtn.addEventListener("click",Se);n.stopBtn.addEventListener("click",()=>{T&&(T.abort(),T=null,ge(),ee(!1))});n.micBtn.addEventListener("click",()=>{if(!("webkitSpeechRecognition"in window))return alert("Voice not supported.");if(I){I.stop();return}I=new webkitSpeechRecognition,I.continuous=!1,I.interimResults=!0,I.lang="en-US",I.onstart=()=>{n.micBtn.classList.add("listening"),n.messageInput.placeholder="Listening..."},I.onresult=e=>{let t="";for(let o=e.resultIndex;o<e.results.length;++o)t+=e.results[o][0].transcript;n.messageInput.value=t,X()},I.onend=()=>{n.micBtn.classList.remove("listening"),I=null,n.messageInput.placeholder="Type your message..."},I.start()});function R(){me("chat"),Ae(a.quickPrompts,t=>{n.messageInput.value=t+" ",n.messageInput.focus()});const e=D();$e(e?e.messages:[],a.model)}async function Se(){const e=n.messageInput.value.trim();if(!e&&k.length===0)return;const t=D();if(!t)return;ge();const o=n.includePageContent.checked;let i=e;if(ee(!0),o){const l=await Ce();l&&(i+=`

[Page Content]:
${l}`)}let s;k.length>0?(s=[],i&&s.push({type:"text",text:i}),k.forEach(l=>{s.push({type:"image_url",image_url:{url:l.base64}})})):s=i,t.messages.push({role:"user",content:s}),Z(t.messages),W("user",s),n.messageInput.value="",n.includePageContent.checked=!1,X(),k=[],te([],()=>{});const r="msg-"+Date.now();W("assistant",null,r,!0),T=new AbortController;let c="";try{const l=Me(a,s,T.signal);for await(const d of l)c+=d,Pe(r,c);t.messages.push({role:"assistant",content:c}),Z(t.messages),fe(t.messages),re(r,c),a.autoRead&&he(c)}catch(l){l.name!=="AbortError"?(Te(r),W("error",`Error: ${l.message}`)):c&&(t.messages.push({role:"assistant",content:c}),Z(t.messages),re(r,c))}finally{ee(!1),T=null}}
