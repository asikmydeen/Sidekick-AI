(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const d of o)if(d.type==="childList")for(const c of d.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function s(o){const d={};return o.integrity&&(d.integrity=o.integrity),o.referrerPolicy&&(d.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?d.credentials="include":o.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function i(o){if(o.ep)return;o.ep=!0;const d=s(o);fetch(o.href,d)}})();function xe(){(typeof chrome>"u"||!chrome.storage)&&(console.log("Running in web preview mode - mocking Chrome APIs"),window.chrome={storage:{local:{get:async e=>{const t={};return(Array.isArray(e)?e:[e]).forEach(i=>{const o=localStorage.getItem(i);o&&(t[i]=JSON.parse(o))}),t},set:async e=>{Object.entries(e).forEach(([t,s])=>{localStorage.setItem(t,JSON.stringify(s))})}}},runtime:{onInstalled:{addListener:()=>{}},onMessage:{addListener:()=>{}}},tabs:{query:async()=>[{id:1,url:"https://example.com"}]},scripting:{executeScript:async({target:e,func:t})=>[{result:`This is a mock page content from the web preview mode.

It simulates what the extension would read from a real webpage.`}]},sidePanel:{setPanelBehavior:async()=>{}}})}const pe=`Summarize|Summarize the key points of the following content:
Explain|Explain this concept in simple terms:
Fix Grammar|Please fix the grammar in this text:
Code Review|Review this code for bugs and improvements:`;function he(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}let r={provider:"",model:"",apiKey:"",endpoint:"http://localhost:11434",awsAccessKey:"",awsSecretKey:"",awsSessionToken:"",awsRegion:"us-east-1",systemPrompt:"",temperature:.7,quickPrompts:pe,theme:"light",autoRead:!1,currentSessionId:null,sessions:[],providerCredentials:{openai:{apiKey:"",selectedModel:"",models:[]},openrouter:{apiKey:"",selectedModel:"",models:[]},anthropic:{apiKey:"",selectedModel:"",models:[]},huggingface:{apiKey:"",selectedModel:"",models:[],task:"chat",taskModels:{}},ollama:{endpoint:"http://localhost:11434",selectedModel:"",models:[]},bedrock:{accessKey:"",secretKey:"",sessionToken:"",region:"us-east-1",selectedModel:"",models:[]}}};const Le={chat:["meta-llama/Llama-3.2-3B-Instruct","meta-llama/Llama-3.1-8B-Instruct","Qwen/Qwen2.5-72B-Instruct","mistralai/Mistral-7B-Instruct-v0.3","deepseek-ai/DeepSeek-R1-Distill-Qwen-32B"],"text-to-image":["black-forest-labs/FLUX.1-dev","black-forest-labs/FLUX.1-schnell","stabilityai/stable-diffusion-xl-base-1.0","stabilityai/stable-diffusion-3-medium","ByteDance/SDXL-Lightning"],"image-to-text":["Salesforce/blip-image-captioning-large","Salesforce/blip-image-captioning-base","nlpconnect/vit-gpt2-image-captioning","microsoft/git-base"],"text-to-speech":["facebook/mms-tts-eng","espnet/kan-bayashi_ljspeech_vits","microsoft/speecht5_tts","suno/bark-small"],"speech-to-text":["openai/whisper-large-v3","openai/whisper-medium","openai/whisper-small","facebook/wav2vec2-large-960h-lv60-self"]};function A(e){return!r.providerCredentials||!r.providerCredentials[e]?null:{...r.providerCredentials[e]}}function H(e,t){r.providerCredentials||(r.providerCredentials={}),r.providerCredentials[e]||(r.providerCredentials[e]={}),r.providerCredentials[e]={...r.providerCredentials[e],...t},D()}function Te(){return A(r.provider)}async function Me(){const e=await chrome.storage.local.get(["chatState"]);if(e.chatState){if(!e.chatState.providerCredentials){if(e.chatState.providerCredentials={openai:{apiKey:"",selectedModel:"",models:[]},openrouter:{apiKey:"",selectedModel:"",models:[]},anthropic:{apiKey:"",selectedModel:"",models:[]},huggingface:{apiKey:"",selectedModel:"",models:[]},ollama:{endpoint:"http://localhost:11434",selectedModel:"",models:[]},bedrock:{accessKey:"",secretKey:"",sessionToken:"",region:"us-east-1",selectedModel:"",models:[]}},e.chatState.apiKey){const t=e.chatState.provider;(t==="openai"||t==="openrouter"||t==="anthropic"||t==="huggingface")&&(e.chatState.providerCredentials[t].apiKey=e.chatState.apiKey)}e.chatState.endpoint&&(e.chatState.providerCredentials.ollama.endpoint=e.chatState.endpoint||"http://localhost:11434"),e.chatState.awsAccessKey&&(e.chatState.providerCredentials.bedrock.accessKey=e.chatState.awsAccessKey),e.chatState.awsSecretKey&&(e.chatState.providerCredentials.bedrock.secretKey=e.chatState.awsSecretKey),e.chatState.awsSessionToken&&(e.chatState.providerCredentials.bedrock.sessionToken=e.chatState.awsSessionToken),e.chatState.awsRegion&&(e.chatState.providerCredentials.bedrock.region=e.chatState.awsRegion)}if(r.providerCredentials.ollama.endpoint||(r.providerCredentials.ollama.endpoint="http://localhost:11434"),r.providerCredentials.bedrock.region||(r.providerCredentials.bedrock.region="us-east-1"),Object.keys(r.providerCredentials).forEach(t=>{r.providerCredentials[t].models||(r.providerCredentials[t].models=[]),r.providerCredentials[t].selectedModel||(r.providerCredentials[t].selectedModel="")}),e.chatState.messages&&!e.chatState.sessions){const t={id:he(),title:"Previous Chat",messages:e.chatState.messages,lastModified:Date.now()};r={...r,...e.chatState,sessions:[t],currentSessionId:t.id},delete r.messages}else r={...r,...e.chatState};r.temperature===void 0&&(r.temperature=.7),r.autoRead===void 0&&(r.autoRead=!1),r.quickPrompts||(r.quickPrompts=pe),r.endpoint||(r.endpoint="http://localhost:11434"),r.awsRegion||(r.awsRegion="us-east-1"),r.sessions.length===0?z():(!r.currentSessionId||!r.sessions.find(t=>t.id===r.currentSessionId))&&(r.currentSessionId=r.sessions[0].id)}else z();return r}function D(){chrome.storage.local.set({chatState:r})}function oe(e){r={...r,...e},D()}function z(){const e={id:he(),title:"New Chat",messages:[],lastModified:Date.now()};return r.sessions.unshift(e),r.currentSessionId=e.id,D(),e}function J(){return r.sessions.find(e=>e.id===r.currentSessionId)}function B(e){var s;const t=J();if(t){if(t.messages=e,t.lastModified=Date.now(),t.title==="New Chat"&&e.length>0){const i=e.find(o=>o.role==="user");if(i){let o=i.content;Array.isArray(o)&&(o=((s=o.find(d=>d.type==="text"))==null?void 0:s.text)||"Image"),t.title=o.slice(0,30)+(o.length>30?"...":"")}}D()}}function $e(e){r.sessions=r.sessions.filter(t=>t.id!==e),r.currentSessionId===e&&(r.sessions.length>0?r.currentSessionId=r.sessions[0].id:z()),D()}function Ae(e){r.sessions.find(s=>s.id===e)&&(r.currentSessionId=e,D())}function Ke(){r.sessions=[],z()}async function Pe(){try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e)return null;if(e.url.startsWith("chrome://"))return"Cannot read system pages.";const t=await chrome.scripting.executeScript({target:{tabId:e.id},func:()=>document.body.innerText});if(t&&t[0]&&t[0].result){const s=t[0].result;return s.length>2e4?s.substring(0,2e4)+`
...[Content Truncated]`:s}return null}catch(e){return console.error("Failed to read page:",e),`Error reading page: ${e.message}`}}function Re(e){return Math.ceil(e.length/4)}function He(e){return new Promise((t,s)=>{const i=new FileReader;i.onload=o=>t(o.target.result),i.onerror=o=>s(o),i.readAsText(e)})}const n={container:document.querySelector(".container"),configSection:document.getElementById("configSection"),chatSection:document.getElementById("chatSection"),advancedSettings:document.getElementById("advancedSettings"),providerSelect:document.getElementById("provider"),apiKeyInput:document.getElementById("apiKey"),apiKeyGroup:document.getElementById("apiKeyGroup"),endpointInput:document.getElementById("endpoint"),endpointGroup:document.getElementById("endpointGroup"),awsGroup:document.getElementById("awsGroup"),awsAccessKey:document.getElementById("awsAccessKey"),awsSecretKey:document.getElementById("awsSecretKey"),awsSessionToken:document.getElementById("awsSessionToken"),awsRegion:document.getElementById("awsRegion"),hfTaskGroup:document.getElementById("hfTaskGroup"),hfTaskSelect:document.getElementById("hfTask"),hfTaskHint:document.getElementById("hfTaskHint"),fetchModelsBtn:document.getElementById("fetchModelsBtn"),fetchStatus:document.getElementById("fetchStatus"),modelSelect:document.getElementById("model"),modelSelectionDiv:document.getElementById("modelSelection"),manualModelGroup:document.getElementById("manualModelGroup"),manualModelInput:document.getElementById("manualModel"),saveModelBtn:document.getElementById("saveModelBtn"),modelHint:document.getElementById("modelHint"),systemPromptInput:document.getElementById("systemPrompt"),temperatureInput:document.getElementById("temperature"),tempValueLabel:document.getElementById("tempValue"),quickPromptsInput:document.getElementById("quickPromptsConfig"),autoReadInput:document.getElementById("autoRead"),startChatBtn:document.getElementById("startChatBtn"),settingsBtn:document.getElementById("settingsBtn"),historyBtn:document.getElementById("historyBtn"),newChatBtn:document.getElementById("newChatBtn"),historySidebar:document.getElementById("historySidebar"),sessionList:document.getElementById("sessionList"),closeSidebarBtn:document.getElementById("closeSidebarBtn"),clearHistoryBtn:document.getElementById("clearHistoryBtn"),exportBtn:document.getElementById("exportBtn"),themeBtn:document.getElementById("themeBtn"),chatHistory:document.getElementById("chatHistory"),messageInput:document.getElementById("messageInput"),sendBtn:document.getElementById("sendBtn"),stopBtn:document.getElementById("stopBtn"),micBtn:document.getElementById("micBtn"),fileBtn:document.getElementById("fileBtn"),fileInput:document.getElementById("fileInput"),includePageContent:document.getElementById("includePageContent"),promptChipsContainer:document.getElementById("promptChips"),tokenCount:document.getElementById("tokenCount"),attachmentPreview:document.getElementById("attachmentPreview")};function ge(e){e==="dark"?(document.body.classList.add("dark-mode"),n.themeBtn.textContent="â˜€ï¸"):(document.body.classList.remove("dark-mode"),n.themeBtn.textContent="ðŸŒ™")}function k(e,t){n.fetchStatus.textContent=e,n.fetchStatus.className=`status-msg ${t}`}function fe(e){e==="chat"?(n.configSection.classList.add("hidden"),n.chatSection.classList.remove("hidden"),n.settingsBtn.style.display="block",n.historyBtn.classList.remove("hidden"),n.newChatBtn.classList.remove("hidden"),n.exportBtn.classList.remove("hidden")):(n.configSection.classList.remove("hidden"),n.chatSection.classList.add("hidden"),n.settingsBtn.style.display="none",n.historyBtn.classList.add("hidden"),n.newChatBtn.classList.add("hidden"),n.exportBtn.classList.add("hidden"))}function ae(e){e?n.historySidebar.classList.add("open"):n.historySidebar.classList.remove("open")}function le(e,t){const s=document.createElement("a");s.href=e,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s)}function ie(e,t,s,i){n.sessionList.innerHTML="",e.forEach(o=>{const d=document.createElement("div");d.className=`session-item ${o.id===t?"active":""}`;let c=o.title||"New Chat";const l=document.createElement("span");l.className="session-title",l.textContent=c,l.onclick=()=>s(o.id);const a=document.createElement("button");a.textContent="Ã—",a.className="session-delete",a.onclick=u=>{u.stopPropagation(),i(o.id)},d.appendChild(l),d.appendChild(a),n.sessionList.appendChild(d)})}function re(e){n.modelSelect.innerHTML='<option value="" disabled selected>Select a model...</option>',e.forEach(t=>{const s=document.createElement("option");s.value=t,s.textContent=t,n.modelSelect.appendChild(s)})}function De(e){if(Array.from(n.modelSelect.options).find(i=>i.value===e)){n.modelSelect.value=e;return}const s=document.createElement("option");s.value=e,s.textContent=e,n.modelSelect.appendChild(s),n.modelSelect.value=e}function Oe(e,t){n.promptChipsContainer.innerHTML="",e.split(`
`).forEach(i=>{if(!i.trim())return;const o=i.split("|"),d=o[0].trim(),c=o.length>1?o.slice(1).join("|").trim():d;if(!d)return;const l=document.createElement("button");l.className="chip",l.textContent=d,l.title=c,l.addEventListener("click",()=>t(c)),n.promptChipsContainer.appendChild(l)})}function Ne(e,t){n.chatHistory.innerHTML="";const s=document.createElement("div");s.className="status-msg",s.textContent=`Chatting with ${t}`,n.chatHistory.appendChild(s),e.forEach(i=>{f(i.role,i.content)}),se(),Se(e)}function f(e,t,s=null,i=!1){var c;const o=document.createElement("div");o.className=`message ${e}`,s&&(o.id=s);let d="";if(typeof t=="string"?d=t:Array.isArray(t)&&(d=((c=t.find(l=>l.type==="text"))==null?void 0:c.text)||""),i)o.innerHTML='<div class="typing-dots"><span></span><span></span><span></span></div>';else if(Array.isArray(t)?t.forEach(l=>{if(l.type==="text"){const a=document.createElement("div");a.innerHTML=ne(l.text),o.appendChild(a)}else if(l.type==="image_url"){const a=document.createElement("img");a.src=l.image_url.url,a.className="chat-image",o.appendChild(a)}else if(l.type==="generated_image"){const a=document.createElement("div");a.className="generated-media-container";const u=document.createElement("img");u.src=l.url,u.className="generated-image",u.alt=l.prompt||"Generated image",a.appendChild(u);const m=document.createElement("button");m.className="media-btn",m.textContent="â¬‡ï¸ Download",m.onclick=()=>le(l.url,"generated-image.png"),a.appendChild(m),o.appendChild(a)}else if(l.type==="generated_audio"){const a=document.createElement("div");a.className="generated-media-container";const u=document.createElement("audio");u.src=l.url,u.controls=!0,u.className="generated-audio",a.appendChild(u);const m=document.createElement("button");m.className="media-btn",m.textContent="â¬‡ï¸ Download",m.onclick=()=>le(l.url,"generated-audio.wav"),a.appendChild(m),o.appendChild(a)}else if(l.type==="audio_input"){const a=document.createElement("audio");a.src=l.url,a.controls=!0,a.className="input-audio",o.appendChild(a)}}):t&&(o.innerHTML=ne(t)),e==="assistant"&&d){const l=document.createElement("div");l.className="msg-controls";const a=document.createElement("button");a.className="msg-btn",a.textContent="ðŸ”Š",a.title="Read aloud",a.onclick=()=>ye(d,a),l.appendChild(a),o.appendChild(l)}n.chatHistory.appendChild(o),o.querySelectorAll(".copy-btn").forEach(l=>{l.addEventListener("click",a=>{const u=a.target.parentElement.querySelector("code").textContent;navigator.clipboard.writeText(u);const m=a.target.textContent;a.target.textContent="Copied!",a.target.classList.add("copied"),setTimeout(()=>{a.target.textContent=m,a.target.classList.remove("copied")},2e3)})}),se()}function _e(e,t){const s=document.getElementById(e);s&&(s.innerHTML=ne(t),se())}function ue(e,t){const s=document.getElementById(e);if(s){s.innerHTML="";let i="";typeof t=="string"&&(i=t);const o=document.createElement("div");o.innerHTML=ne(i),s.appendChild(o);const d=document.createElement("div");d.className="msg-controls";const c=document.createElement("button");c.className="msg-btn",c.textContent="ðŸ”Š",c.title="Read aloud",c.onclick=()=>ye(i,c),d.appendChild(c),s.appendChild(d),s.querySelectorAll(".copy-btn").forEach(l=>{l.addEventListener("click",a=>{const u=a.target.parentElement.querySelector("code").textContent;navigator.clipboard.writeText(u);const m=a.target.textContent;a.target.textContent="Copied!",a.target.classList.add("copied"),setTimeout(()=>{a.target.textContent=m,a.target.classList.remove("copied")},2e3)})}),se()}}function ye(e,t){if(window.speechSynthesis.speaking){window.speechSynthesis.cancel(),document.querySelectorAll(".msg-btn.speaking").forEach(s=>{s.classList.remove("speaking"),s.textContent="ðŸ”Š"});return}ve(e,t)}function ve(e,t=null){window.speechSynthesis.cancel();const s=e.replace(/[*#`_\[\]]/g,""),i=new SpeechSynthesisUtterance(s);i.lang="en-US",i.rate=1,i.onstart=()=>{t&&(t.classList.add("speaking"),t.textContent="â¹")},i.onend=()=>{t&&(t.classList.remove("speaking"),t.textContent="ðŸ”Š")},i.onerror=()=>{t&&(t.classList.remove("speaking"),t.textContent="ðŸ”Š")},window.speechSynthesis.speak(i)}function we(){window.speechSynthesis.cancel()}function Se(e){let t="";e.forEach(d=>{typeof d.content=="string"?t+=d.content:Array.isArray(d.content)&&d.content.forEach(c=>{c.type==="text"&&(t+=c.text),c.type==="image_url"&&(t+=" ".repeat(4e3))})});const s=Re(t),o=Math.min(s/128e3*100,100).toFixed(1);n.tokenCount.textContent=`${s.toLocaleString()} tokens used`,n.tokenCount.title=`Approx. ${o}% of 128k context window`}function q(e){const t=document.getElementById(e);t&&t.remove()}function P(e){e?(n.sendBtn.classList.add("hidden"),n.stopBtn.classList.remove("hidden"),n.messageInput.disabled=!0):(n.sendBtn.classList.remove("hidden"),n.stopBtn.classList.add("hidden"),n.messageInput.disabled=!1,n.messageInput.focus())}function se(){n.chatHistory.scrollTop=n.chatHistory.scrollHeight}function W(){const e=n.messageInput;e.style.height="auto",e.style.height=e.scrollHeight+"px",e.value===""&&(e.style.height="")}function $(e,t){n.attachmentPreview.innerHTML="",e.forEach((s,i)=>{const o=document.createElement("div");if(o.className="preview-thumb",s.type==="audio"){const c=document.createElement("div");c.className="audio-preview-icon",c.textContent="ðŸŽµ",c.title=s.name||"Audio file",o.appendChild(c)}else{const c=document.createElement("img");c.src=s.base64,o.appendChild(c)}const d=document.createElement("button");d.className="remove-btn",d.textContent="Ã—",d.onclick=()=>t(i),o.appendChild(d),n.attachmentPreview.appendChild(o)})}function ne(e){if(!e)return"";let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");const s=[];return t=t.replace(/```([\s\S]*?)```/g,(i,o)=>(s.push(o),`__CODEBLOCK_${s.length-1}__`)),t=t.replace(/^### (.*$)/gm,"<h3>$1</h3>"),t=t.replace(/^## (.*$)/gm,"<h2>$1</h2>"),t=t.replace(/^# (.*$)/gm,"<h1>$1</h1>"),t=t.replace(/^[\*\-] (.*$)/gm,"<ul><li>$1</li></ul>"),t=t.replace(/`([^`]+)`/g,'<code style="background:rgba(128,128,128,0.2);padding:2px 4px;border-radius:4px;">$1</code>'),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/\*([^*]+)\*/g,"<em>$1</em>"),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>'),t=t.replace(/\n/g,"<br>"),t=t.replace(/__CODEBLOCK_(\d+)__/g,(i,o)=>`<div class="code-wrapper"><button class="copy-btn">Copy</button><pre><code>${s[o]}</code></pre></div>`),t}async function F(e,t){const s=new TextEncoder,i=typeof e=="string"?s.encode(e):e,o=await crypto.subtle.importKey("raw",i,{name:"HMAC",hash:"SHA-256"},!1,["sign"]);return crypto.subtle.sign("HMAC",o,s.encode(t))}async function me(e){const t=new TextEncoder,s=await crypto.subtle.digest("SHA-256",t.encode(e));return Array.from(new Uint8Array(s)).map(i=>i.toString(16).padStart(2,"0")).join("")}function je(e){return Array.from(new Uint8Array(e)).map(t=>t.toString(16).padStart(2,"0")).join("")}async function ke({method:e,url:t,headers:s,body:i,accessKey:o,secretKey:d,sessionToken:c,region:l,service:a}){const m=new Date().toISOString().replace(/[:-]|\.\d{3}/g,""),T=m.slice(0,8),M=new URL(t).host,V=new URL(t).pathname,Q="";s.host=M,s["x-amz-date"]=m,c&&(s["x-amz-security-token"]=c);const N={};Object.keys(s).forEach(p=>{N[p.toLowerCase()]=s[p]});const _=Object.keys(s).map(p=>p.toLowerCase()).sort(),X=_.map(p=>`${p}:${N[p].trim()}
`).join(""),j=_.join(";"),Y=await me(i||""),Z=[e,V,Q,X,j,Y].join(`
`),U="AWS4-HMAC-SHA256",G=`${T}/${l}/${a}/aws4_request`,ee=[U,m,G,await me(Z)].join(`
`),te=await F(`AWS4${d}`,T),v=await F(te,l),I=await F(v,a),g=await F(I,"aws4_request"),S=je(await F(g,ee)),L=`${U} Credential=${o}/${G}, SignedHeaders=${j}, Signature=${S}`;return{...s,Authorization:L}}async function Ue(e,t){let s="",i={},o=c=>[];switch(e){case"openai":s="https://api.openai.com/v1/models",i={Authorization:`Bearer ${t.apiKey}`},o=u=>u.data.map(m=>m.id).filter(m=>m.startsWith("gpt")).sort();break;case"openrouter":s="https://openrouter.ai/api/v1/models",i={Authorization:`Bearer ${t.apiKey}`},o=u=>u.data.map(m=>m.id).sort();break;case"huggingface":return["meta-llama/Llama-3.2-3B-Instruct","meta-llama/Llama-3.1-8B-Instruct","Qwen/Qwen2.5-72B-Instruct","mistralai/Mistral-7B-Instruct-v0.3","deepseek-ai/DeepSeek-R1-Distill-Qwen-32B","google/gemma-2-9b-it"];case"anthropic":return["claude-sonnet-4-20250514","claude-3-5-sonnet-20241022","claude-3-5-haiku-20241022","claude-3-opus-20240229","claude-3-haiku-20240307"];case"ollama":s=`${t.endpoint.replace(/\/$/,"")}/api/tags`,o=u=>u.models.map(m=>m.name);break;case"bedrock":const l=t.region||"us-east-1";s=`https://bedrock.${l}.amazonaws.com/foundation-models?byOutputModality=TEXT`,i=await ke({method:"GET",url:s,headers:{"content-type":"application/json"},accessKey:t.accessKey,secretKey:t.secretKey,sessionToken:t.sessionToken,region:l,service:"bedrock"}),o=u=>u.modelSummaries.map(m=>m.modelId).sort();break;default:throw new Error("Unknown provider")}const d=await fetch(s,{headers:i});if(!d.ok){const c=await d.text();throw new Error(`API Error ${d.status}: ${c}`)}return o(await d.json())}async function*Ge(e,t,s){var V,Q,N,_,X,j,Y,Z,U,G,ee,te;console.log("[DEBUG] streamChatApi called",{provider:e.provider,model:e.model});const{provider:i,model:o,temperature:d,systemPrompt:c}=e,l=((V=e.sessions.find(v=>v.id===e.currentSessionId))==null?void 0:V.messages)||[];console.log("[DEBUG] Getting credentials for provider:",i);const a=Te();if(!a)throw console.error("[DEBUG] No credentials found for provider:",i),new Error(`No credentials configured for provider: ${i}`);console.log("[DEBUG] Credentials:",a);let u="",m={"Content-Type":"application/json"};const T=[];c&&i!=="bedrock"&&T.push({role:"system",content:c});const M=l.map(v=>({role:v.role,content:v.content}));if(M.push({role:"user",content:t}),i==="openai"||i==="openrouter"){a.apiKey&&(m.Authorization=`Bearer ${a.apiKey}`),T.push(...M),u=i==="openai"?"https://api.openai.com/v1/chat/completions":"https://openrouter.ai/api/v1/chat/completions";const I=await fetch(u,{method:"POST",headers:m,body:JSON.stringify({model:o,messages:T,stream:!0,temperature:d}),signal:s});if(!I.ok)throw new Error(await I.text());const g=I.body.getReader(),S=new TextDecoder;for(;;){const{done:L,value:p}=await g.read();if(L)break;const b=S.decode(p,{stream:!0}).split(`
`);for(const y of b)if(y.startsWith("data: ")&&!y.includes("[DONE]"))try{const x=((_=(N=(Q=JSON.parse(y.replace("data: ","")).choices)==null?void 0:Q[0])==null?void 0:N.delta)==null?void 0:_.content)||"";x&&(yield x)}catch{}}}else if(i==="ollama"){u=`${a.endpoint?a.endpoint.replace(/\/$/,""):"http://localhost:11434"}/api/chat`;const I=M.map(w=>{if(Array.isArray(w.content)){let b="";return w.content.forEach(y=>{y.type==="text"&&(b+=y.text)}),{role:w.role,content:b}}return w}),g={model:o,messages:I,stream:!0};c&&(g.system=c),d!==void 0&&(g.options={temperature:d});const S=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g),signal:s});if(!S.ok){const w=await S.text();throw new Error(`Ollama error ${S.status}: ${w}`)}const L=S.body.getReader(),p=new TextDecoder;for(;;){const{done:w,value:b}=await L.read();if(w)break;const C=p.decode(b,{stream:!0}).split(`
`);for(const x of C)if(x.trim())try{const K=JSON.parse(x);(X=K.message)!=null&&X.content&&(yield K.message.content)}catch{}}}else if(i==="bedrock"){const v=a.region||"us-east-1";u=`https://bedrock-runtime.${v}.amazonaws.com/model/${o}/converse`;const g={messages:M.map(y=>{const C=[];return Array.isArray(y.content)?y.content.forEach(x=>{x.type==="text"&&C.push({text:x.text})}):C.push({text:y.content}),{role:y.role,content:C}}),inferenceConfig:{temperature:d,maxTokens:2048}};c&&(g.system=[{text:c}]);const S=JSON.stringify(g),L=await ke({method:"POST",url:u,headers:{"content-type":"application/json"},body:S,accessKey:a.accessKey,secretKey:a.secretKey,sessionToken:a.sessionToken,region:v,service:"bedrock"}),p=await fetch(u,{method:"POST",headers:L,body:S,signal:s});if(!p.ok)throw new Error(await p.text());yield((U=(Z=(Y=(j=(await p.json()).output)==null?void 0:j.message)==null?void 0:Y.content)==null?void 0:Z[0])==null?void 0:U.text)||""}else if(i==="huggingface"){u="https://router.huggingface.co/v1/chat/completions";const v=M.map(p=>{var b;const w=Array.isArray(p.content)?(b=p.content.find(y=>y.type==="text"))==null?void 0:b.text:p.content;return{role:p.role,content:w}});c&&v.unshift({role:"system",content:c});const I={model:o,messages:v,max_tokens:2048,temperature:d,stream:!0},g=await fetch(u,{method:"POST",headers:{Authorization:`Bearer ${a.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(I),signal:s});if(!g.ok){const p=await g.text();throw g.status===404||g.status===422?new Error(`Model "${o}" not found. Check the model name and provider format.`):new Error(`Hugging Face API error (${g.status}): ${p}`)}const S=g.body.getReader(),L=new TextDecoder;for(;;){const{done:p,value:w}=await S.read();if(p)break;const y=L.decode(w,{stream:!0}).split(`
`);for(const C of y)if(C.startsWith("data: ")&&!C.includes("[DONE]"))try{const K=((te=(ee=(G=JSON.parse(C.replace("data: ","")).choices)==null?void 0:G[0])==null?void 0:ee.delta)==null?void 0:te.content)||"";K&&(yield K)}catch{}}}}async function Fe(e,t,s,i={}){const o=`https://router.huggingface.co/hf-inference/models/${e}`,d={inputs:t,parameters:{guidance_scale:i.guidanceScale||7.5,num_inference_steps:i.steps||30,width:i.width||512,height:i.height||512,negative_prompt:i.negativePrompt||""}},c=await fetch(o,{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify(d)});if(!c.ok){const a=await c.text();throw new Error(`Image generation failed (${c.status}): ${a}`)}const l=await c.blob();return new Promise((a,u)=>{const m=new FileReader;m.onloadend=()=>a(m.result),m.onerror=u,m.readAsDataURL(l)})}async function qe(e,t,s){var l;const i=`https://router.huggingface.co/hf-inference/models/${e}`;let o;if(typeof t=="string"&&t.startsWith("data:")){const a=t.split(",")[1];o=Uint8Array.from(atob(a),u=>u.charCodeAt(0))}else t instanceof Blob?o=await t.arrayBuffer():o=t;const d=await fetch(i,{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/octet-stream"},body:o});if(!d.ok){const a=await d.text();throw new Error(`Image captioning failed (${d.status}): ${a}`)}const c=await d.json();return Array.isArray(c)&&((l=c[0])!=null&&l.generated_text)?c[0].generated_text:JSON.stringify(c)}async function ze(e,t,s){const i=`https://router.huggingface.co/hf-inference/models/${e}`,o=await fetch(i,{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify({inputs:t})});if(!o.ok){const c=await o.text();throw new Error(`Speech generation failed (${o.status}): ${c}`)}const d=await o.blob();return new Promise((c,l)=>{const a=new FileReader;a.onloadend=()=>c(a.result),a.onerror=l,a.readAsDataURL(d)})}async function Je(e,t,s){const i=`https://router.huggingface.co/hf-inference/models/${e}`;let o;if(typeof t=="string"&&t.startsWith("data:")){const l=t.split(",")[1];o=Uint8Array.from(atob(l),a=>a.charCodeAt(0))}else t instanceof Blob?o=await t.arrayBuffer():o=t;const d=await fetch(i,{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"audio/flac"},body:o});if(!d.ok){const l=await d.text();throw new Error(`Speech recognition failed (${d.status}): ${l}`)}const c=await d.json();return c.text||JSON.stringify(c)}xe();let R=null,E=null,h=[];document.addEventListener("DOMContentLoaded",async()=>{if(await Me(),ge(r.theme),r.provider&&(n.providerSelect.value=r.provider,Ce(r.provider),Be(r.provider)),r.systemPrompt&&(n.systemPromptInput.value=r.systemPrompt),r.temperature&&(n.temperatureInput.value=r.temperature,n.tempValueLabel.textContent=r.temperature),r.quickPrompts&&(n.quickPromptsInput.value=r.quickPrompts),r.autoRead&&(n.autoReadInput.checked=r.autoRead),r.model){const e=J();e&&e.messages.length>0&&(n.modelSelect.innerHTML=`<option value="${r.model}" selected>${r.model}</option>`,n.modelSelectionDiv.classList.remove("hidden"),n.advancedSettings.classList.remove("hidden"),n.startChatBtn.classList.remove("hidden"),O())}});n.providerSelect.addEventListener("change",e=>Be(e.target.value));function be(){const e=r.provider;if(!e)return;let t={};switch(e){case"openai":case"openrouter":case"anthropic":case"huggingface":t.apiKey=n.apiKeyInput.value.trim();break;case"ollama":t.endpoint=n.endpointInput.value.trim();break;case"bedrock":t.accessKey=n.awsAccessKey.value.trim(),t.secretKey=n.awsSecretKey.value.trim(),t.sessionToken=n.awsSessionToken.value.trim(),t.region=n.awsRegion.value.trim();break}H(e,t)}function Ce(e){const t=A(e);if(t){switch(n.apiKeyInput.value="",n.endpointInput.value="",n.awsAccessKey.value="",n.awsSecretKey.value="",n.awsSessionToken.value="",n.awsRegion.value="us-east-1",e){case"openai":case"openrouter":case"anthropic":case"huggingface":t.apiKey&&(n.apiKeyInput.value=t.apiKey);break;case"ollama":t.endpoint&&(n.endpointInput.value=t.endpoint);break;case"bedrock":t.accessKey&&(n.awsAccessKey.value=t.accessKey),t.secretKey&&(n.awsSecretKey.value=t.secretKey),t.sessionToken&&(n.awsSessionToken.value=t.sessionToken),t.region&&(n.awsRegion.value=t.region);break}t.models&&t.models.length>0&&(re(t.models),n.modelSelectionDiv.classList.remove("hidden"),n.advancedSettings.classList.remove("hidden"),n.startChatBtn.classList.remove("hidden"),t.selectedModel&&(n.modelSelect.value=t.selectedModel))}}function We(e){if(n.apiKeyGroup.classList.add("hidden"),n.endpointGroup.classList.add("hidden"),n.awsGroup.classList.add("hidden"),n.hfTaskGroup.classList.add("hidden"),e==="ollama"?n.endpointGroup.classList.remove("hidden"):e==="bedrock"?n.awsGroup.classList.remove("hidden"):n.apiKeyGroup.classList.remove("hidden"),e==="huggingface"){n.hfTaskGroup.classList.remove("hidden");const t=A(e);t!=null&&t.task&&(n.hfTaskSelect.value=t.task)}}const Ve=["huggingface","anthropic"];function Qe(e){if(Ve.includes(e))if(n.manualModelGroup.classList.remove("hidden"),e==="huggingface"){const t=n.hfTaskSelect.value||"chat";Ee(t)}else e==="anthropic"&&(n.modelHint.innerHTML="e.g., <code>claude-sonnet-4-20250514</code>, <code>claude-3-5-haiku-20241022</code>");else n.manualModelGroup.classList.add("hidden")}function Ee(e){const t={chat:"e.g., <code>meta-llama/Llama-3.2-3B-Instruct</code>, <code>deepseek-ai/DeepSeek-V3:novita</code>","text-to-image":"e.g., <code>black-forest-labs/FLUX.1-dev</code>, <code>stabilityai/stable-diffusion-xl-base-1.0</code>","image-to-text":"e.g., <code>Salesforce/blip-image-captioning-large</code>","text-to-speech":"e.g., <code>facebook/mms-tts-eng</code>, <code>suno/bark-small</code>","speech-to-text":"e.g., <code>openai/whisper-large-v3</code>"};n.modelHint.innerHTML=t[e]||t.chat}n.hfTaskSelect.addEventListener("change",()=>{const e=n.hfTaskSelect.value;H("huggingface",{task:e}),Ee(e);const t=Le[e]||[];re(t),t.length>0&&(n.modelSelectionDiv.classList.remove("hidden"),n.advancedSettings.classList.remove("hidden"),n.startChatBtn.classList.remove("hidden")),H("huggingface",{models:t})});function Be(e){be(),oe({provider:e}),Ce(e),We(e),Qe(e),n.modelSelectionDiv.classList.add("hidden"),n.advancedSettings.classList.add("hidden"),n.startChatBtn.classList.add("hidden")}n.themeBtn.addEventListener("click",()=>{const e=r.theme==="light"?"dark":"light";oe({theme:e}),ge(e)});n.settingsBtn.addEventListener("click",()=>fe("config"));n.startChatBtn.addEventListener("click",()=>{const e=n.modelSelect.value;if(!e)return k("Please select a model.","error");oe({model:e,systemPrompt:n.systemPromptInput.value.trim(),temperature:parseFloat(n.temperatureInput.value),quickPrompts:n.quickPromptsInput.value.trim(),autoRead:n.autoReadInput.checked}),O()});n.historyBtn.addEventListener("click",()=>{ie(r.sessions,r.currentSessionId,ce,de),ae(!0)});n.closeSidebarBtn.addEventListener("click",()=>ae(!1));n.newChatBtn.addEventListener("click",()=>{z(),O()});n.clearHistoryBtn.addEventListener("click",()=>{confirm("Delete all history? This cannot be undone.")&&(Ke(),ie(r.sessions,r.currentSessionId,ce,de),O())});function ce(e){Ae(e),O(),ae(!1)}function de(e){confirm("Delete this chat?")&&($e(e),ie(r.sessions,r.currentSessionId,ce,de),r.currentSessionId!==e&&O())}n.exportBtn.addEventListener("click",()=>{const e=J();if(!e||e.messages.length===0)return alert("No history to export.");let t=`# ${e.title}

`;e.messages.forEach(d=>{var c;if(Array.isArray(d.content)){const l=((c=d.content.find(a=>a.type==="text"))==null?void 0:c.text)||"";t+=`### ${d.role}
${l}
[Image Attached]

`}else t+=`### ${d.role}
${d.content}

`});const s=new Blob([t],{type:"text/markdown"}),i=URL.createObjectURL(s),o=document.createElement("a");o.href=i,o.download=`chat-${e.id}.md`,o.click(),URL.revokeObjectURL(i)});n.fileBtn.addEventListener("click",()=>n.fileInput.click());n.fileInput.addEventListener("change",async e=>{const t=e.target.files[0];if(t){if(t.type.startsWith("image/")){const s=new FileReader;s.onload=i=>{const o=i.target.result;h.push({type:"image_url",base64:o}),$(h,d=>{h.splice(d,1),$(h,()=>{})})},s.readAsDataURL(t),e.target.value="";return}if(t.type.startsWith("audio/")){const s=new FileReader;s.onload=i=>{const o=i.target.result;h.push({type:"audio",base64:o,name:t.name}),$(h,d=>{h.splice(d,1),$(h,()=>{})})},s.readAsDataURL(t),e.target.value="";return}try{const s=await He(t);if(/[\x00-\x08\x0E-\x1F]/.test(s))throw new Error("File content appears to be binary.");const i=`

[File Attachment: ${t.name}]
\`\`\`
${s}
\`\`\``;n.messageInput.value+=i,W()}catch(s){alert("Failed to read file. Please upload images, audio, or text files."),console.error(s)}e.target.value=""}});n.fetchModelsBtn.addEventListener("click",async()=>{const e=n.providerSelect.value;if(!e)return k("Select a provider.","error");be();const t=A(e);if(e==="bedrock"){if(!t.accessKey||!t.secretKey)return k("Enter AWS Credentials.","error")}else if(e!=="ollama"&&!t.apiKey)return k("Enter API Key.","error");k("Fetching...","info");try{const s=await Ue(e,t);if(!s.length)throw new Error("No models found.");re(s),k(`Found ${s.length} models.`,"success"),n.modelSelectionDiv.classList.remove("hidden"),n.advancedSettings.classList.remove("hidden"),n.startChatBtn.classList.remove("hidden"),H(e,{models:s})}catch(s){k(`Error: ${s.message}`,"error")}});n.modelSelect.addEventListener("change",()=>{const e=r.provider,t=n.modelSelect.value;e&&t&&H(e,{selectedModel:t})});n.saveModelBtn.addEventListener("click",()=>{const e=n.manualModelInput.value.trim();if(!e){k("Please enter a model name.","error");return}const t=r.provider;De(e);const i=A(t).models||[];i.includes(e)||i.push(e),H(t,{models:i,selectedModel:e}),n.modelSelectionDiv.classList.remove("hidden"),n.advancedSettings.classList.remove("hidden"),n.startChatBtn.classList.remove("hidden"),n.manualModelInput.value="",k(`Model "${e}" added.`,"success")});n.manualModelInput.addEventListener("keypress",e=>{e.key==="Enter"&&(e.preventDefault(),n.saveModelBtn.click())});n.temperatureInput.addEventListener("input",e=>n.tempValueLabel.textContent=e.target.value);n.messageInput.addEventListener("input",W);n.messageInput.addEventListener("keypress",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),Ie())});n.sendBtn.addEventListener("click",Ie);n.stopBtn.addEventListener("click",()=>{R&&(R.abort(),R=null,we(),P(!1))});n.micBtn.addEventListener("click",()=>{if(!("webkitSpeechRecognition"in window))return alert("Voice not supported.");if(E){E.stop();return}E=new webkitSpeechRecognition,E.continuous=!1,E.interimResults=!0,E.lang="en-US",E.onstart=()=>{n.micBtn.classList.add("listening"),n.messageInput.placeholder="Listening..."},E.onresult=e=>{let t="";for(let s=e.resultIndex;s<e.results.length;++s)t+=e.results[s][0].transcript;n.messageInput.value=t,W()},E.onend=()=>{n.micBtn.classList.remove("listening"),E=null,n.messageInput.placeholder="Type your message..."},E.start()});function O(){fe("chat"),Oe(r.quickPrompts,t=>{n.messageInput.value=t+" ",n.messageInput.focus()});const e=J();Ne(e?e.messages:[],r.model)}async function Ie(){var u;const e=n.messageInput.value.trim();if(!e&&h.length===0)return;const t=J();if(!t)return;we();const s=n.includePageContent.checked;let i=e;if(P(!0),s){const m=await Pe();m&&(i+=`

[Page Content]:
${m}`)}const o=r.provider,d=o==="huggingface"?((u=A("huggingface"))==null?void 0:u.task)||"chat":null;if(o==="huggingface"&&d!=="chat"){await Xe(d,i,t);return}let c;h.length>0?(c=[],i&&c.push({type:"text",text:i}),h.forEach(m=>{c.push({type:"image_url",image_url:{url:m.base64}})})):c=i,t.messages.push({role:"user",content:c}),B(t.messages),f("user",c),n.messageInput.value="",n.includePageContent.checked=!1,W(),h=[],$([],()=>{});const l="msg-"+Date.now();f("assistant",null,l,!0),R=new AbortController;let a="";try{const m=Ge(r,c,R.signal);for await(const T of m)a+=T,_e(l,a);t.messages.push({role:"assistant",content:a}),B(t.messages),Se(t.messages),ue(l,a),r.autoRead&&ve(a)}catch(m){m.name!=="AbortError"?(q(l),f("error",`Error: ${m.message}`)):a&&(t.messages.push({role:"assistant",content:a}),B(t.messages),ue(l,a))}finally{P(!1),R=null}}async function Xe(e,t,s){const i=A("huggingface"),o=r.model,d=i.apiKey;n.messageInput.value="",W();try{switch(e){case"text-to-image":{s.messages.push({role:"user",content:t}),B(s.messages),f("user",t);const c="msg-"+Date.now();f("assistant",null,c,!0);const l=await Fe(o,t,d);q(c);const a=[{type:"generated_image",url:l,prompt:t}];s.messages.push({role:"assistant",content:a}),B(s.messages),f("assistant",a);break}case"image-to-text":{if(h.length===0){k("Please attach an image first.","error"),P(!1);return}const c=h[0].base64,l=[{type:"text",text:t||"Describe this image"},{type:"image_url",image_url:{url:c}}];s.messages.push({role:"user",content:l}),B(s.messages),f("user",l),h=[],$([],()=>{});const a="msg-"+Date.now();f("assistant",null,a,!0);const u=await qe(o,c,d);q(a),s.messages.push({role:"assistant",content:u}),B(s.messages),f("assistant",u);break}case"text-to-speech":{s.messages.push({role:"user",content:t}),B(s.messages),f("user",t);const c="msg-"+Date.now();f("assistant",null,c,!0);const l=await ze(o,t,d);q(c);const a=[{type:"generated_audio",url:l}];s.messages.push({role:"assistant",content:a}),B(s.messages),f("assistant",a);break}case"speech-to-text":{if(h.length===0){k("Please attach an audio file first.","error"),P(!1);return}const c=h[0].base64,l=[{type:"audio_input",url:c}];s.messages.push({role:"user",content:l}),B(s.messages),f("user",l),h=[],$([],()=>{});const a="msg-"+Date.now();f("assistant",null,a,!0);const u=await Je(o,c,d);q(a),s.messages.push({role:"assistant",content:u}),B(s.messages),f("assistant",u);break}default:k(`Unknown task: ${e}`,"error")}}catch(c){f("error",`Error: ${c.message}`)}finally{P(!1)}}
